package ultrasignal

// CrossCorrelate вычисляет взаимную корреляцию двух сигналов x и y.
//
// Математическая формула (дискретная кросс-корреляция):
//
//	R_xy[k] = ∑ₙ x[n]·y[n - k]  (для всех допустимых n)
//
// Реализация учитывает все значения лагов от -(len(y)-1) до len(x)-1,
// таким образом получая полную кросс-корреляционную функцию длиной len(x)+len(y)-1.
//
// Это позволяет определить схожесть между сигналами и возможные сдвиги во времени.
//
// Параметры:
//
//	x — сигнал (основной)
//	y — шаблон (сравниваемый сигнал)
//
// Возвращает:
//
//	corr — массив взаимной корреляции, центрированный по нулевому лагу (сдвигу).
func CrossCorrelate(x, y []float64) []float64 {
	n := len(x)
	m := len(y)
	corr := make([]float64, n+m-1)

	for lag := -(m - 1); lag < n; lag++ {
		sum := 0.0
		for i := 0; i < m; i++ {
			j := i + lag
			if j >= 0 && j < n {
				sum += y[i] * x[j]
			}
		}
		corr[lag+m-1] = sum
	}
	return corr
}
